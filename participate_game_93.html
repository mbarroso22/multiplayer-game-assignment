<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <style>
    canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 1px solid black;}
      h1 { text-align: center;}
  </style>
</head>
<body>
    <h1>
        COM440 Multi-User Game
    </h1>
  <canvas id="game" width="800" height="600"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var start_time;
    const circ_r = 8;
      
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const msg = sessionStorage.getItem('mySessionName') || '_';
    console.log("Session st: " + msg)
    //const socket = io();
    const socket = io("http://145.132.97.96:3003",{
        auth: {
            token: msg
        }
    });

    let playerId = null;
    const players = {}; // id â†’ { x, y, color }

    socket.on('init', ({ id, players: allPlayers }) => {
        playerId = id;
        Object.assign(players, allPlayers);
    });

    socket.on('join', (player) => {
        players[player.id] = player;
        console.log(Object.keys(players).length);
    });

    socket.on('move', ({ id, x, y }) => {
        if (players[id]) {
            players[id].x = x;
            players[id].y = y;
            const elapsed = performance.now() - start_time;
            console.log(`Elapsed: ${elapsed.toFixed(2)} ms`);
        }
    });

    socket.on('update', ({ players: allPlayers }) => {
        for (const id in allPlayers){
            players[id].rf = allPlayers[id].rf;
            players[id].health = allPlayers[id].health;
        }
    });
      
    socket.on('leave', (id) => {
        delete players[id];
    });

    document.addEventListener('keydown', (e) => {
        const me = players[playerId];
        if (!me) return;
        const speed = 5;
        if (e.key === 'ArrowUp')    me.y = Math.max(me.y - speed, 0);
        if (e.key === 'ArrowDown')  me.y = Math.min(me.y + speed, canvas.height);
        if (e.key === 'ArrowLeft')  me.x = Math.max(me.x - speed, 0);
        if (e.key === 'ArrowRight') me.x = Math.min(me.x + speed, canvas.width);
        socket.emit('move', { x: me.x, y: me.y });
        console.log('Keypress/emit ' + me.x + ' : ' + me.y + ' : ' + canvas.height);
        start_time = performance.now();
    });

    canvas.addEventListener('click', evt => {
        const rectBounds = canvas.getBoundingClientRect();
        const mouseX = evt.clientX - rectBounds.left;
        const mouseY = evt.clientY - rectBounds.top;

        // Distance from click to circle center
        const dx = mouseX - players[playerId].x;
        const dy = mouseY - players[playerId].y;
        if (Math.sqrt(dx*dx + dy*dy) <= circ_r) {
            // alert('Circle clicked!');
            socket.emit('shrink', { rf: circ_r });
            // players[playerId].rf = circ_r;
        }
        
    });
      
      
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const id in players) {
            const p = players[id];
            if( p.health > 0){
                ctx.beginPath();
                ctx.arc(p.x, p.y, circ_r, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();

                if (id === playerId) {
                    ctx.strokeStyle = '#F00';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                // the field of influence
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.rf, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }else{
                ctx.font = "24px Georgia";
                ctx.fillStyle = "red"; 
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText('X', p.x, p.y);
            }

            ctx.font = "16px Georgia";
            ctx.fillStyle = "black"; 
            ctx.textAlign = "center";   // left, right, center
            ctx.textBaseline = "bottom"; // top, hanging, middle, alphabetic, ideographic, bottom
            ctx.fillText(p.name, p.x, p.y-1.5*circ_r);
            ctx.font = "12px Georgia";
            ctx.fillText(p.health.toFixed(0), p.x, p.y+3.5*circ_r);

        }
        requestAnimationFrame(draw);
    }

    draw();
  </script>
        
</body>
</html>