<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <style>
    canvas { background: #f0f0f0; display: block; margin: 20px auto; border: 1px solid black;}
      h1 { text-align: center;}
  </style>
</head>
<body>
    <h1>
        COM440 Multi-User Game
    </h1>
  <canvas id="game" width="800" height="600"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const msg = sessionStorage.getItem('mySessionName') || '_';
    //console.log("Session st: " + msg)
    //const socket = io();
    const socket = io("http://145.132.97.96:3003",{
        auth: {
            token: msg
        }
    });

    let playerId = null;
    const players = {}; // id â†’ { x, y, color }

    socket.on('init', ({ id, players: allPlayers }) => {
        playerId = id;
        Object.assign(players, allPlayers);
    });

    socket.on('join', (player) => {
        players[player.id] = player;
        //console.log(Object.keys(players).length);
    });

    socket.on('move', ({ id, x, y }) => {
        if (players[id]) {
            players[id].x = x;
            players[id].y = y;
        }
    });

    socket.on('update', ({ players: allPlayers }) => {
        for (const id in allPlayers){
            players[id].health = allPlayers[id].health; // only copy health as an example
            players[id].x = allPlayers[id].x;
            players[id].y = allPlayers[id].y;
        }
    });
      
    socket.on('leave', (id) => {
        delete players[id];
    });

    document.addEventListener('keydown', (e) => {
        const me = players[playerId];
        if (!me) return;
        const speed = 5;
        if (e.key === 'ArrowUp')    me.y = Math.max(me.y - speed, 0);
        if (e.key === 'ArrowDown')  me.y = Math.min(me.y + speed, canvas.height);
        if (e.key === 'ArrowLeft')  me.x = Math.max(me.x - speed, 0);
        if (e.key === 'ArrowRight') me.x = Math.min(me.x + speed, canvas.width);
        socket.emit('move', { x: me.x, y: me.y });
        //console.log('Keypress/emit ' + me.x + ' : ' + me.y + ' : ' + canvas.height);
    });

    canvas.addEventListener('click', evt => {
        const rectBounds = canvas.getBoundingClientRect();
        const mouseX = evt.clientX - rectBounds.left;
        const mouseY = evt.clientY - rectBounds.top;

        socket.emit('jump', { xy: 25 });
       
    });
      
      
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const id in players) {
            const p = players[id];

            ctx.font = "24px Georgia";
            ctx.fillStyle = "red"; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText('*', p.x, p.y);
            
            ctx.font = "14px Georgia";
            ctx.textAlign = "left";
            ctx.fillStyle = "black";
            ctx.fillText(p.name, p.x+6, p.y);
        }

        requestAnimationFrame(draw);
    }

    draw();
  </script>
        
</body>
</html>