<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <style>
    canvas { background: #f0f0f0; display: block; margin: 20px auto; }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="600"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var start_time;
    const circ_r = 8;
      
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const msg = sessionStorage.getItem('mySessionName') || '(no data)';
    console.log("Session st: " + msg)
    // const socket = io();
    const socket = io("http://20.81.200.60:3003",{
        auth: {
            token: msg
        }
    }); 

    let playerId = null;
    const players = {}; // id â†’ { x, y, color }

    socket.on('init', ({ id, players: allPlayers }) => {
        playerId = id;
        Object.assign(players, allPlayers);
    });

    socket.on('join', (player) => {
        players[player.id] = player;
        console.log(Object.keys(players).length);
    });

    socket.on('move', ({ id, x, y }) => {
        if (players[id]) {
            players[id].x = x;
            players[id].y = y;
            const elapsed = performance.now() - start_time;
            console.log(`Elapsed: ${elapsed.toFixed(2)} ms`);
        }
    });

    socket.on('leave', (id) => {
        delete players[id];
    });

    document.addEventListener('keydown', (e) => {
        const me = players[playerId];
        if (!me) return;
        const speed = 5;
        if (e.key === 'ArrowUp')    me.y -= speed;
        if (e.key === 'ArrowDown')  me.y += speed;
        if (e.key === 'ArrowLeft')  me.x -= speed;
        if (e.key === 'ArrowRight') me.x += speed;
        socket.emit('move', { x: me.x, y: me.y });
        
        start_time = performance.now();
    });

    canvas.addEventListener('click', evt => {
        const rectBounds = canvas.getBoundingClientRect();
        const mouseX = evt.clientX - rectBounds.left;
        const mouseY = evt.clientY - rectBounds.top;

        // Distance from click to circle center
        const dx = mouseX - players[playerId].x;
        const dy = mouseY - players[playerId].y;
        if (Math.sqrt(dx*dx + dy*dy) <= circ_r) {
        alert('Circle clicked!');
        }
    });
      
      
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const id in players) {
            const p = players[id];
            ctx.beginPath();
            ctx.arc(p.x, p.y, circ_r, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            if (id === playerId) {
                ctx.strokeStyle = '#F00';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            ctx.font = "24px Arial";
            ctx.fillStyle = "blue"; 
            ctx.textAlign = "center";   // left, right, center
            ctx.textBaseline = "bottom"; // top, hanging, middle, alphabetic, ideographic, bottom
            ctx.fillText(p.name, p.x, p.y-2*circ_r);

        }
        requestAnimationFrame(draw);
    }

    draw();
  </script>
        
</body>
</html>